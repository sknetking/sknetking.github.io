<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WhatsApp-Style P2P Chat</title>
    <script src="https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary-color: #128C7E;
            --primary-dark: #075E54;
            --primary-light: #25D366;
            --sent-message: #DCF8C6;
            --received-message: #FFFFFF;
            --chat-bg: #ECE5DD;
            --header-bg: #F0F2F5;
            --input-bg: #FFFFFF;
            --icon-color: #54656F;
            --call-icon: #128C7E;
            --video-icon: #4A89DC;
            --end-call: #FF3B30;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #128C7E, #075E54);
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }
        
        .app-container {
            width: 100%;
            max-width: 1000px;
            height: 90vh;
            display: flex;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3);
            border-radius: 10px;
            overflow: hidden;
        }
        
        /* Sidebar Styles */
        .sidebar {
            width: 35%;
            background: var(--header-bg);
            border-right: 1px solid #e0e0e0;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        
        .profile-header {
            background: var(--primary-dark);
            padding: 15px 20px;
            color: white;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .profile-info {
            display: flex;
            align-items: center;
        }
        
        .avatar {
            width: 45px;
            height: 45px;
            border-radius: 50%;
            background: var(--primary-light);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 20px;
            margin-right: 15px;
            color: white;
        }
        
        .profile-name {
            font-size: 18px;
            font-weight: 600;
        }
        
        .profile-id {
            font-size: 12px;
            opacity: 0.8;
        }
        
        .action-icons {
            display: flex;
            gap: 20px;
        }
        
        .action-icons i {
            font-size: 20px;
            cursor: pointer;
            color: white;
        }
        
        /* Connection Panel */
        .connection-panel {
            padding: 15px;
            background: white;
            border-bottom: 1px solid #e0e0e0;
        }
        
        .input-group {
            display: flex;
            margin-bottom: 10px;
        }
        
        .input-group input {
            flex: 1;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
        }
        
        .input-group button {
            background: var(--primary-color);
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 5px;
            margin-left: 10px;
            cursor: pointer;
            font-weight: 500;
            transition: background 0.3s;
        }
        
        .input-group button:hover {
            background: var(--primary-dark);
        }
        
        .peer-status {
            font-size: 14px;
            padding: 5px;
            margin-top: 5px;
            display: flex;
            justify-content: space-between;
        }
        
        .peer-status span {
            font-weight: 500;
        }
        
        /* Chats Container */
        .chats-container {
            flex: 1;
            overflow-y: auto;
        }
        
        .chat-item {
            display: flex;
            padding: 12px;
            border-bottom: 1px solid #f0f0f0;
            cursor: pointer;
            transition: background 0.2s;
        }
        
        .chat-item:hover {
            background: #f5f5f5;
        }
        
        .chat-avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: #ddd;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 18px;
            margin-right: 15px;
            color: #555;
        }
        
        .chat-info {
            flex: 1;
        }
        
        .chat-name {
            font-weight: 600;
            margin-bottom: 3px;
        }
        
        .chat-preview {
            font-size: 13px;
            color: #777;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 200px;
        }
        
        /* Main Chat Area */
        .main-chat {
            width: 65%;
            display: flex;
            flex-direction: column;
            background: var(--chat-bg);
            background-image: url("data:image/svg+xml,%3Csvg width='100' height='100' viewBox='0 0 100 100' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M11 18c3.866 0 7-3.134 7-7s-3.134-7-7-7-7 3.134-7 7 3.134 7 7 7zm48 25c3.866 0 7-3.134 7-7s-3.134-7-7-7-7 3.134-7 7 3.134 7 7 7zm-43-7c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zm63 31c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zM34 90c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zm56-76c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zM12 86c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm28-65c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm23-11c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm-6 60c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm29 22c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zM32 63c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm57-13c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm-9-21c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM60 91c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM35 41c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM12 60c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2z' fill='%23e0e0e0' fill-opacity='0.3' fill-rule='evenodd'/%3E%3C/svg%3E");
            position: relative;
        }
        
        .chat-header {
            background: var(--header-bg);
            padding: 15px 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            border-bottom: 1px solid #e0e0e0;
        }
        
        .chat-contact {
            display: flex;
            align-items: center;
        }
        
        .contact-name {
            font-weight: 600;
            font-size: 16px;
            margin-left: 15px;
        }
        
        .chat-controls {
            display: flex;
            gap: 25px;
            color: var(--icon-color);
        }
        
        .chat-controls i {
            font-size: 20px;
            cursor: pointer;
        }
        
        .call-controls {
            display: flex;
            gap: 15px;
        }
        
        .call-controls i {
            color: var(--call-icon);
        }
        
        .video-call-btn {
            color: var(--video-icon) !important;
        }
        
        .end-call-btn {
            color: var(--end-call) !important;
        }
        
        /* Messages Container */
        .messages-container {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
        }
        
        .message {
            max-width: 70%;
            padding: 10px 15px;
            margin-bottom: 10px;
            border-radius: 7.5px;
            position: relative;
            word-wrap: break-word;
            animation: fadeIn 0.3s;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .sent {
            background: var(--sent-message);
            align-self: flex-end;
            border-top-right-radius: 0;
        }
        
        .received {
            background: var(--received-message);
            align-self: flex-start;
            border-top-left-radius: 0;
            box-shadow: 0 1px 1px rgba(0, 0, 0, 0.1);
        }
        
        .message-time {
            font-size: 11px;
            color: #999;
            text-align: right;
            margin-top: 3px;
        }
        
        .file-message {
            padding: 15px;
            border-radius: 7.5px;
            display: flex;
            align-items: center;
            cursor: pointer;
            transition: background 0.2s;
        }
        
        .file-message:hover {
            background: rgba(0, 0, 0, 0.05);
        }
        
        .file-icon {
            font-size: 36px;
            margin-right: 15px;
            color: var(--primary-color);
        }
        
        .file-info {
            flex: 1;
        }
        
        .file-name {
            font-weight: 500;
            margin-bottom: 5px;
            word-break: break-all;
        }
        
        .file-size {
            font-size: 12px;
            color: #777;
        }
        
        .download-btn {
            background: var(--primary-color);
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
        }
        
        /* Video call container */
        .video-container {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: black;
            z-index: 50;
            display: none;
            flex-direction: column;
        }
        
        .remote-video {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .local-video {
            position: absolute;
            bottom: 20px;
            right: 20px;
            width: 150px;
            height: 100px;
            border-radius: 5px;
            border: 2px solid white;
            object-fit: cover;
            z-index: 51;
        }
        
        .video-controls {
            position: absolute;
            bottom: 20px;
            left: 0;
            width: 100%;
            display: flex;
            justify-content: center;
            gap: 20px;
            z-index: 51;
        }
        
        .video-control-btn {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 20px;
            cursor: pointer;
            transition: background 0.3s;
        }
        
        .video-control-btn:hover {
            background: rgba(255, 255, 255, 0.3);
        }
        
        .end-video-call-btn {
            background: var(--end-call);
        }
        
        /* Input Area */
        .input-area {
            background: var(--input-bg);
            padding: 10px 15px;
            display: flex;
            align-items: center;
            border-top: 1px solid #e0e0e0;
        }
        
        .input-area i {
            font-size: 24px;
            color: var(--icon-color);
            margin: 0 10px;
            cursor: pointer;
        }
        
        .message-input {
            flex: 1;
            padding: 12px 15px;
            border: none;
            border-radius: 20px;
            background: #f0f2f5;
            font-size: 15px;
            outline: none;
        }
        
        .send-btn {
            background: var(--primary-color);
            color: white;
            border: none;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: background 0.3s;
        }
        
        .send-btn:hover {
            background: var(--primary-dark);
        }
        
        .send-btn i {
            color: white;
            margin: 0;
            font-size: 18px;
        }
        
        /* File input */
        #fileInput {
            display: none;
        }
        
        /* Call notification */
        .call-notification {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 25px;
            border-radius: 10px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.2);
            text-align: center;
            z-index: 100;
            display: none;
        }
        
        .call-notification p {
            margin: 15px 0;
            font-size: 18px;
        }
        
        .call-notification-btns {
            display: flex;
            gap: 15px;
            justify-content: center;
        }
        
        .call-notification-btn {
            padding: 10px 25px;
            border-radius: 50px;
            border: none;
            font-weight: 500;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .answer-btn {
            background: var(--primary-color);
            color: white;
        }
        
        .video-answer-btn {
            background: var(--video-icon);
            color: white;
        }
        
        .reject-btn {
            background: var(--end-call);
            color: white;
        }
        
        /* How to use section */
        .how-to-use {
            background: white;
            margin-top: 20px;
            padding: 15px;
            border-radius: 10px;
            font-size: 14px;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.1);
        }
        
        .how-to-use h2 {
            margin-bottom: 10px;
            color: var(--primary-dark);
        }
        
        .how-to-use p {
            margin-bottom: 8px;
            line-height: 1.5;
        }
        
        .how-to-use mark {
            background: #f0f8ff;
            padding: 2px 5px;
            border-radius: 3px;
        }
        
        /* Responsive */
        @media (max-width: 768px) {
            .app-container {
                flex-direction: column;
                height: 95vh;
            }
            
            .sidebar, .main-chat {
                width: 100%;
            }
            
            .sidebar {
                height: 40%;
            }
            
            .main-chat {
                height: 60%;
            }
        }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- Sidebar -->
        <div class="sidebar">
            <div class="profile-header">
                <div class="profile-info">
                    <div class="avatar" id="userAvatar">U</div>
                    <div>
                        <div class="profile-name" id="userName">User</div>
                        <div class="profile-id">Your ID: <span id="yourId">Generating...</span></div>
                    </div>
                </div>
                <div class="action-icons">
                    <i class="fas fa-users"></i>
                    <i class="fas fa-ellipsis-v"></i>
                </div>
            </div>
            
            <div class="connection-panel">
                <div class="input-group">
                    <input type="text" id="customIdInput" placeholder="Set your name (e.g. John)">
                    <button id="setCustomIdBtn">Set</button>
                </div>
                
                <div class="input-group">
                    <input type="text" id="peerIdInput" placeholder="Peer ID to connect (e.g. Mary42)">
                    <button id="connectBtn">Connect</button>
                </div>
                
                <div class="peer-status">
                    <div>Connected to: <span id="peerName">None</span></div>
                    <div id="connectionStatus">Disconnected</div>
                </div>
            </div>
            
            <div class="chats-container">
                <div class="chat-item">
                    <div class="chat-avatar">S</div>
                    <div class="chat-info">
                        <div class="chat-name">Shyam</div>
                        <div class="chat-preview">Online</div>
                    </div>
                </div>
                <div class="chat-item">
                    <div class="chat-avatar">A</div>
                    <div class="chat-info">
                        <div class="chat-name">Alex</div>
                        <div class="chat-preview">Offline</div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Main Chat Area -->
        <div class="main-chat">
            <div class="chat-header">
                <div class="chat-contact">
                    <div class="avatar" id="peerAvatar">P</div>
                    <div class="contact-name" id="currentPeer">Peer</div>
                </div>
                <div class="chat-controls">
                    <div class="call-controls">
                        <i class="fas fa-phone-alt" id="callBtn" title="Start Audio Call"></i>
                        <i class="fas fa-video video-call-btn" id="videoCallBtn" title="Start Video Call"></i>
                        <i class="fas fa-phone-slash end-call-btn" id="endCallBtn" title="End Call"></i>
                    </div>
                    <i class="fas fa-ellipsis-v"></i>
                </div>
            </div>
            
            <div class="messages-container" id="messages">
                <!-- Messages will be inserted here -->
            </div>
            
            <div class="input-area">
                <i class="fas fa-paperclip" id="attachBtn" title="Attach file"></i>
                <input type="text" class="message-input" id="messageInput" placeholder="Type a message" disabled>
                <div class="send-btn" id="sendBtn">
                    <i class="fas fa-paper-plane"></i>
                </div>
            </div>
            
            <input type="file" id="fileInput">
            
            <!-- Video Call Container -->
            <div class="video-container" id="videoContainer">
                <video class="remote-video" id="remoteVideo" autoplay></video>
                <video class="local-video" id="localVideo" autoplay muted></video>
                <div class="video-controls">
                    <div class="video-control-btn" id="muteVideoBtn">
                        <i class="fas fa-microphone"></i>
                    </div>
                    <div class="video-control-btn end-video-call-btn" id="endVideoCallBtn">
                        <i class="fas fa-phone-slash"></i>
                    </div>
                    <div class="video-control-btn" id="videoOffBtn">
                        <i class="fas fa-video"></i>
                    </div>
                </div>
            </div>
            
            <!-- Call Notification -->
            <div class="call-notification" id="callNotification">
                <i class="fas fa-phone-volume fa-3x" id="callNotificationIcon" style="color: var(--primary-color);"></i>
                <p>Incoming <span id="callType">call</span> from <span id="callerName"></span></p>
                <div class="call-notification-btns">
                    <button class="call-notification-btn answer-btn" id="answerCallBtn">
                        <i class="fas fa-phone"></i> Answer
                    </button>
                    <button class="call-notification-btn video-answer-btn" id="answerVideoCallBtn" style="display: none;">
                        <i class="fas fa-video"></i> Video
                    </button>
                    <button class="call-notification-btn reject-btn" id="rejectCallBtn">
                        <i class="fas fa-times"></i> Reject
                    </button>
                </div>
            </div>
        </div>
    </div>
      
    <audio id="remoteAudio" style="display: none;" controls></audio>
    <audio id="ringtone" style="display: none;" controls loop>
        <source src="https://github.com/sknetking/useascdn/raw/refs/heads/main/original-phone-ringtone.mp3" type="audio/mpeg">
    </audio>

    <script>
        // DOM elements
        const yourIdEl = document.getElementById('yourId');
        const peerNameEl = document.getElementById('peerName');
        const peerIdInput = document.getElementById('peerIdInput');
        const connectBtn = document.getElementById('connectBtn');
        const messageInput = document.getElementById('messageInput');
        const sendBtn = document.getElementById('sendBtn');
        const messagesEl = document.getElementById('messages');
        const customIdInput = document.getElementById('customIdInput');
        const setCustomIdBtn = document.getElementById('setCustomIdBtn');
        const callBtn = document.getElementById('callBtn');
        const videoCallBtn = document.getElementById('videoCallBtn');
        const endCallBtn = document.getElementById('endCallBtn');
        const callNotification = document.getElementById('callNotification');
        const answerCallBtn = document.getElementById('answerCallBtn');
        const answerVideoCallBtn = document.getElementById('answerVideoCallBtn');
        const rejectCallBtn = document.getElementById('rejectCallBtn');
        const callerNameEl = document.getElementById('callerName');
        const callTypeEl = document.getElementById('callType');
        const callNotificationIcon = document.getElementById('callNotificationIcon');
        const remoteAudio = document.getElementById('remoteAudio');
        const ringtone = document.getElementById('ringtone');
        const fileInput = document.getElementById('fileInput');
        const attachBtn = document.getElementById('attachBtn');
        const connectionStatus = document.getElementById('connectionStatus');
        const userAvatar = document.getElementById('userAvatar');
        const userName = document.getElementById('userName');
        const peerAvatar = document.getElementById('peerAvatar');
        const currentPeer = document.getElementById('currentPeer');
        const videoContainer = document.getElementById('videoContainer');
        const remoteVideo = document.getElementById('remoteVideo');
        const localVideo = document.getElementById('localVideo');
        const muteVideoBtn = document.getElementById('muteVideoBtn');
        const endVideoCallBtn = document.getElementById('endVideoCallBtn');
        const videoOffBtn = document.getElementById('videoOffBtn');
        
        // App state
        let peer;
        let conn;
        let currentStream;
        let call;
        let incomingCall = null;
        let currentPeerName = '';
        let remotePeerName = '';
        let connectionOpen = false;
        let isVideoCall = false;
        let isMuted = false;
        let isVideoOff = false;
        
        // Initialize the app
        function initialize() {
            createPeerConnection();
            setupEventListeners();
        }
        
        // Create memorable ID from name with random number
        function generateMemorableId(name) {
            if (!name) return null;
            const cleanName = name.replace(/[^a-zA-Z0-9]/g, '').toLowerCase();
            const randomNum = Math.floor(Math.random() * 90) + 10; // 10-99
            return `${cleanName}${randomNum}`;
        }
        
        // Create PeerJS connection
        function createPeerConnection() {
            if (peer && !peer.destroyed) peer.destroy();
            
            // Try to get stored ID from localStorage
            const storedName = localStorage.getItem('peerjs_username');
            let peerId = localStorage.getItem('peerjs_custom_id');
            
            // If no stored ID, generate a temporary one
            if (!peerId) {
                peerId = `user${Math.floor(Math.random() * 9000) + 1000}`;
            }
            
            peer = new Peer(peerId, {
                host: '0.peerjs.com',
                port: 443,
                path: '/',
                secure: true,
                debug: 2,
                config: {
                    iceServers: [
                        { urls: 'stun:stun.l.google.com:19302' },
                        { urls: 'stun:stun1.l.google.com:19302' }
                    ]
                }
            });
            
            peer.on('open', id => {
                yourIdEl.textContent = id;
                if (storedName) {
                    userName.textContent = storedName;
                    userAvatar.textContent = storedName.charAt(0).toUpperCase();
                }
                logSystemMessage(`✅ Your ID: ${id}`);
            });
            
            peer.on('connection', connection => {
                conn = connection;
                setupConnection();
                
                setTimeout(() => {
                    if (conn.open) {
                        conn.send(JSON.stringify({ 
                            type: 'name-request', 
                            name: currentPeerName 
                        }));
                    }
                }, 500);
            });
            
            peer.on('call', incoming => {
                incomingCall = incoming;
                isVideoCall = incoming.metadata && incoming.metadata.isVideoCall;
                
                callerNameEl.textContent = remotePeerName || incoming.peer;
                callTypeEl.textContent = isVideoCall ? 'video call' : 'call';
                callNotificationIcon.className = isVideoCall ? 'fas fa-video fa-3x' : 'fas fa-phone-volume fa-3x';
                callNotificationIcon.style.color = isVideoCall ? 'var(--video-icon)' : 'var(--primary-color)';
                
                // Show appropriate answer buttons
                answerCallBtn.style.display = isVideoCall ? 'none' : 'flex';
                answerVideoCallBtn.style.display = isVideoCall ? 'flex' : 'none';
                
                callNotification.style.display = 'block';
                playRingtone();
                logSystemMessage(`📞 Incoming ${isVideoCall ? 'video ' : ''}call...`);
            });
            
            peer.on('error', err => {
                console.error(err);
                logSystemMessage(`❌ PeerJS error: ${err.type}`);
            });
        }
        
        // Set up event listeners
        function setupEventListeners() {
            // UI Controls
            setCustomIdBtn.addEventListener('click', setCustomId);
            connectBtn.addEventListener('click', connectToPeer);
            sendBtn.addEventListener('click', sendMessage);
            messageInput.addEventListener('keypress', e => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendMessage();
                }
            });
            
            // Call Controls
            callBtn.addEventListener('click', () => startCall(false));
            videoCallBtn.addEventListener('click', () => startCall(true));
            endCallBtn.addEventListener('click', endCall);
            answerCallBtn.addEventListener('click', () => answerCall(false));
            answerVideoCallBtn.addEventListener('click', () => answerCall(true));
            rejectCallBtn.addEventListener('click', rejectCall);
            
            // Video Call Controls
            muteVideoBtn.addEventListener('click', toggleMute);
            endVideoCallBtn.addEventListener('click', endCall);
            videoOffBtn.addEventListener('click', toggleVideo);
            
            // File Sharing
            attachBtn.addEventListener('click', () => fileInput.click());
            fileInput.addEventListener('change', handleFileSelect);
        }
        
        // Set custom name
        function setCustomId() {
            const name = customIdInput.value.trim();
            if (!name) return;
            
            currentPeerName = name;
            userName.textContent = name;
            userAvatar.textContent = name.charAt(0).toUpperCase();
            customIdInput.value = '';
            
            // Generate and store memorable ID
            const memorableId = generateMemorableId(name);
            localStorage.setItem('peerjs_username', name);
            localStorage.setItem('peerjs_custom_id', memorableId);
            
            // Recreate connection with new ID
            createPeerConnection();
            
            if (connectionOpen) {
                conn.send(JSON.stringify({ 
                    type: 'name', 
                    name: currentPeerName 
                }));
            }
        }
        
        // Connect to peer
        function connectToPeer() {
            const peerId = peerIdInput.value.trim();
            if (!peerId) return;
            
            if (!peer.open) {
                logSystemMessage("⏳ Waiting for peer to be ready...");
                peer.once('open', () => {
                    conn = peer.connect(peerId);
                    setupConnection();
                });
            } else {
                conn = peer.connect(peerId);
                setupConnection();
            }
        }
        
        // Set up data connection
        function setupConnection() {
            conn.on('open', () => {
                logSystemMessage("🔌 Connected to peer!");
                messageInput.disabled = false;
                connectionOpen = true;
                connectionStatus.textContent = "Connected";
                connectionStatus.style.color = "green";
                
                if (currentPeerName) {
                    conn.send(JSON.stringify({ 
                        type: 'name', 
                        name: currentPeerName 
                    }));
                }
            });
            
            conn.on('data', data => {
                try {
                    const parsed = JSON.parse(data);
                    
                    if (parsed.type === 'name') {
                        remotePeerName = parsed.name;
                        peerNameEl.textContent = remotePeerName;
                        currentPeer.textContent = remotePeerName;
                        peerAvatar.textContent = remotePeerName.charAt(0).toUpperCase();
                    } 
                    else if (parsed.type === 'name-request') {
                        if (currentPeerName) {
                            conn.send(JSON.stringify({ 
                                type: 'name', 
                                name: currentPeerName 
                            }));
                        }
                        if (parsed.name) {
                            remotePeerName = parsed.name;
                            peerNameEl.textContent = remotePeerName;
                            currentPeer.textContent = remotePeerName;
                            peerAvatar.textContent = remotePeerName.charAt(0).toUpperCase();
                        }
                    }
                    else if (parsed.type === 'file') {
                        displayFileMessage(parsed, false);
                    }
                } catch {
                    const displayName = remotePeerName ? remotePeerName : conn.peer;
                    displayMessage(data, false, displayName);
                }
            });
            
            conn.on('close', () => {
                logSystemMessage("❌ Disconnected");
                messageInput.disabled = true;
                connectionOpen = false;
                connectionStatus.textContent = "Disconnected";
                connectionStatus.style.color = "red";
                peerNameEl.textContent = 'None';
                callNotification.style.display = 'none';
                endCall();
            });
            
            conn.on('error', err => {
                logSystemMessage(`❌ Connection error: ${err}`);
            });
        }
        
        // Send text message
        function sendMessage() {
            const msg = messageInput.value.trim();
            if (msg && conn?.open) {
                conn.send(msg);
                displayMessage(msg, true);
                messageInput.value = '';
                messageInput.focus();
            }
        }
        
        // Display message in UI
        function displayMessage(msg, isSent, sender = null) {
            const messageDiv = document.createElement('div');
            messageDiv.classList.add('message');
            messageDiv.classList.add(isSent ? 'sent' : 'received');
            
            const now = new Date();
            const timeString = now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            
            messageDiv.innerHTML = `
                <div>${msg}</div>
                <div class="message-time">${timeString}</div>
            `;
            
            messagesEl.appendChild(messageDiv);
            messagesEl.scrollTop = messagesEl.scrollHeight;
        }
        
        // Display file message in UI
        function displayFileMessage(fileInfo, isSent) {
            const messageDiv = document.createElement('div');
            messageDiv.classList.add('message');
            messageDiv.classList.add(isSent ? 'sent' : 'received');
            
            const now = new Date();
            const timeString = now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            
            // Determine file type icon
            let fileIcon = 'fa-file';
            if (fileInfo.type.startsWith('image/')) fileIcon = 'fa-file-image';
            else if (fileInfo.type.startsWith('audio/')) fileIcon = 'fa-file-audio';
            else if (fileInfo.type.startsWith('video/')) fileIcon = 'fa-file-video';
            else if (fileInfo.type.startsWith('text/') || fileInfo.type === 'application/pdf') fileIcon = 'fa-file-alt';
            else if (fileInfo.type === 'application/zip') fileIcon = 'fa-file-archive';
            
            messageDiv.innerHTML = `
                <div class="file-message">
                    <i class="fas ${fileIcon} file-icon"></i>
                    <div class="file-info">
                        <div class="file-name">${fileInfo.name}</div>
                        <div class="file-size">${formatFileSize(fileInfo.size)}</div>
                    </div>
                    <button class="download-btn" data-url="${fileInfo.data}">
                        <i class="fas fa-download"></i>
                    </button>
                </div>
                <div class="message-time">${timeString}</div>
            `;
            
            // Add download functionality
            const downloadBtn = messageDiv.querySelector('.download-btn');
            downloadBtn.addEventListener('click', () => {
                const link = document.createElement('a');
                link.href = fileInfo.data;
                link.download = fileInfo.name;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            });
            
            messagesEl.appendChild(messageDiv);
            messagesEl.scrollTop = messagesEl.scrollHeight;
        }
        
        // Format file size
        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }
        
        // Log system message
        function logSystemMessage(msg) {
            const messageDiv = document.createElement('div');
            messageDiv.classList.add('message');
            messageDiv.classList.add('received');
            messageDiv.style.backgroundColor = '#f0f0f0';
            messageDiv.style.textAlign = 'center';
            messageDiv.style.fontSize = '12px';
            messageDiv.style.padding = '5px 10px';
            messageDiv.textContent = msg;
            messagesEl.appendChild(messageDiv);
            messagesEl.scrollTop = messagesEl.scrollHeight;
        }
        
        // Handle file selection
        function handleFileSelect(e) {
            const file = e.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(event) {
                const fileData = event.target.result;
                
                // Prepare file info to send
                const fileInfo = {
                    type: 'file',
                    name: file.name,
                    size: file.size,
                    mimeType: file.type,
                    data: fileData
                };
                
                // Send file info
                if (conn && conn.open) {
                    conn.send(JSON.stringify(fileInfo));
                    displayFileMessage(fileInfo, true);
                }
                
                // Reset file input
                fileInput.value = '';
            };
            reader.readAsDataURL(file);
        }
        
        // Start audio or video call
        function startCall(videoCall) {
            if (!conn || !conn.open) {
                logSystemMessage("❌ Not connected to any peer");
                return;
            }
            
            isVideoCall = videoCall;
            
            const constraints = {
                audio: true,
                video: videoCall ? { facingMode: "user" } : false
            };
            
            navigator.mediaDevices.getUserMedia(constraints).then(stream => {
                currentStream = stream;
                
                // For video calls, show local video preview
                if (videoCall) {
                    localVideo.srcObject = stream;
                    videoContainer.style.display = 'flex';
                }
                
                // Start the call with metadata
                call = peer.call(conn.peer, stream, {
                    metadata: { isVideoCall: videoCall }
                });
                
                setupCall();
                logSystemMessage(`📞 Starting ${videoCall ? 'video ' : ''}call...`);
            }).catch(err => {
                logSystemMessage(`❌ Cannot access ${videoCall ? 'camera/mic' : 'mic'}: ${err.message}`);
            });
        }
        
        // Answer incoming call
        function answerCall(withVideo) {
            if (!incomingCall) return;
            
            isVideoCall = incomingCall.metadata && incomingCall.metadata.isVideoCall;
            
            const constraints = {
                audio: true,
                video: withVideo ? { facingMode: "user" } : false
            };
            
            navigator.mediaDevices.getUserMedia(constraints).then(stream => {
                currentStream = stream;
                
                // For video calls, show local video preview
                if (withVideo) {
                    localVideo.srcObject = stream;
                    videoContainer.style.display = 'flex';
                }
                
                call = incomingCall;
                call.answer(stream);
                setupCall();
                callNotification.style.display = 'none';
                logSystemMessage(`📞 Answered ${isVideoCall ? 'video ' : ''}call`);
                stopRingtone();
            }).catch(err => {
                logSystemMessage(`❌ Error accessing ${withVideo ? 'camera/mic' : 'mic'}: ${err.message}`);
                callNotification.style.display = 'none';
                stopRingtone();
            });
        }
        
        // Reject incoming call
        function rejectCall() {
            if (incomingCall) {
                incomingCall.close();
                incomingCall = null;
            }
            callNotification.style.display = 'none';
            logSystemMessage("📞 Call rejected");
            stopRingtone();
        }
        
        // Set up call handlers
        function setupCall() {
            call.on('stream', remoteStream => {
                if (isVideoCall) {
                    remoteVideo.srcObject = remoteStream;
                    remoteVideo.play().catch(e => console.warn('Video play failed:', e));
                } else {
                    remoteAudio.srcObject = remoteStream;
                    remoteAudio.play().catch(e => console.warn('Audio play failed:', e));
                }
                
                // Update UI for active call
                callBtn.style.display = 'none';
                videoCallBtn.style.display = 'none';
                endCallBtn.style.display = 'inline-block';
                
                logSystemMessage(`🎧 ${isVideoCall ? 'Video' : 'Audio'} call connected`);
                stopRingtone();
            });
            
            call.on('close', () => {
                endCall();
                logSystemMessage("📞 Call ended");
                stopRingtone();
            });
            
            call.on('error', err => {
                logSystemMessage(`❌ Call error: ${err.message}`);
                endCall();
                stopRingtone();
            });
        }
        
        // End current call
        function endCall() {
            if (call) {
                call.close();
                call = null;
            }
            if (currentStream) {
                currentStream.getTracks().forEach(t => t.stop());
                currentStream = null;
            }
            
            // Reset UI
            callBtn.style.display = 'inline-block';
            videoCallBtn.style.display = 'inline-block';
            endCallBtn.style.display = 'none';
            
            // Hide video container if it was a video call
            if (isVideoCall) {
                videoContainer.style.display = 'none';
                remoteVideo.srcObject = null;
                localVideo.srcObject = null;
                isVideoCall = false;
            } else {
                remoteAudio.srcObject = null;
            }
            
            // Reset call controls
            isMuted = false;
            isVideoOff = false;
            muteVideoBtn.innerHTML = '<i class="fas fa-microphone"></i>';
            videoOffBtn.innerHTML = '<i class="fas fa-video"></i>';
        }
        
        // Toggle mute during call
        function toggleMute() {
            if (!currentStream) return;
            
            const audioTracks = currentStream.getAudioTracks();
            if (audioTracks.length > 0) {
                isMuted = !audioTracks[0].enabled;
                audioTracks[0].enabled = !isMuted;
                muteVideoBtn.innerHTML = isMuted 
                    ? '<i class="fas fa-microphone-slash"></i>' 
                    : '<i class="fas fa-microphone"></i>';
            }
        }
        
        // Toggle video during call
        function toggleVideo() {
            if (!currentStream || !isVideoCall) return;
            
            const videoTracks = currentStream.getVideoTracks();
            if (videoTracks.length > 0) {
                isVideoOff = !videoTracks[0].enabled;
                videoTracks[0].enabled = !isVideoOff;
                videoOffBtn.innerHTML = isVideoOff 
                    ? '<i class="fas fa-video-slash"></i>' 
                    : '<i class="fas fa-video"></i>';
            }
        }
        
        // Play ringtone for incoming call
        function playRingtone() {
            ringtone.play().catch(e => console.log('Ringtone play error:', e));
        }
        
        // Stop ringtone
        function stopRingtone() {
            ringtone.pause();
            ringtone.currentTime = 0;
        }
        
        // Initialize the app when loaded
        window.addEventListener('DOMContentLoaded', initialize);
    </script>
</body>
</html>
